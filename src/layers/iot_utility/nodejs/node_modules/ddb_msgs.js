// Utility to write msgs to DDB
var aws  = require('aws-sdk');

let MSG_TABLE='IOT-MSGS';
// Seconds for expiry time (5 days for testing)
let MSG_EXPIRATION_DURATION = (5*24*60*60);

var _dynoDB= new aws.DynamoDB({apiVersion: 'latest'});

// Return value 'v' if not undefined, else default 'd'
function VoD(v, d) {
    if (v!==undefined) {
        return v;
    }
    return d;
}

// Returns promise or throws error
async function addMsgToTable(id, dir, msg) {
    if (await checkOrCreateTable()) {
        // add to table
        var now = new Date();
        // Build update expression (note don't use AttributeUpdate as docs recommend using UpdateExpression (no reason given...))
        var attrvals = {
                ':d':{ 'S': dir},
                ':mp':{ 'S':VoD(msg.msgProtocol, 'app-core')},
                ':da':{ 'S':VoD(msg.appTag, 'generic')},
                ':t':{ 'S':VoD(msg.type, 'lora')},
                ':c':{ 'S':VoD(msg.connector, 'UNKNOWN')},
                ':et': { 'N': ''+(now.getTime() + MSG_EXPIRATION_DURATION) }

        };
        var updateExpression ='SET dir=:d, msgProtocol=:mp, appTag=:da, nettype=:t, connector=:c, expiryTime=:et';
        if (msg.gwInfo!==undefined) {
            // Todo generic parse of gwinfo (non-lora specific) to get explicit attributes eg rssi? 
            attrvals[':ni'] =  { 'S':JSON.stringify(msg.gwInfo)},
            updateExpression += ', netinfo=:ni';
        }
        if (msg.payload.rawhex!==undefined) {
           attrvals[':rh'] = { 'S':msg.payload.rawhex };
           updateExpression += ', payload_rawhex=:rh';
        }
        if (msg.payload.rawtlv!==undefined) {
            attrvals[':rt'] = { 'S':JSON.stringify(msg.payload.rawtlv) };
            updateExpression += ', payload_rawtlv=:rt';
        }
        if (msg.payload.generic!==undefined) {
            attrvals[':g'] = { 'S':JSON.stringify(msg.payload.generic) };
            updateExpression += ', payload_decoded=:g';
        } else if (msg.payload.config!==undefined || msg.payload.actions!==undefined) {
            attrvals[':g'] = { 'S':JSON.stringify(msg.payload.config)+','+JSON.stringify(msg.payload.actions) };
            updateExpression += ', payload_decoded=:g';
        }
            
        var params = {
            TableName:MSG_TABLE,
            Key: { 
                'DevName': {'S':id}, 
                'Timestamp':{'S':now.toISOString() }, 
            },
            ExpressionAttributeValues : attrvals,
            UpdateExpression : updateExpression
        };
        console.log('updating with:'+JSON.stringify(params));
        return new Promise(function(resolve, reject) {
            _dynoDB.updateItem(params, function(err, data) {
                if (err) {
                    console.log('failed to insert message'+err);
                    reject(err);
                } else {
                    resolve(data);
                }
            })    
        });
    }        
    throw new Error('failed to access table');
}

async function checkOrCreateTable() {
    var tdesc = await new Promise(function(resolve, reject) { 
        _dynoDB.describeTable({ 'TableName':MSG_TABLE}, function(err, data) {
            if (err) {
                console.log('failed to find table:'+err);
                resolve(null);
            } else resolve(data);
        });
    });
    if (tdesc===null) {
        // Create table structure on the fly
        var params = {
            TableName : MSG_TABLE,
            KeySchema: [
                { AttributeName: "DevName", KeyType: "HASH"},
                { AttributeName: "Timestamp", KeyType: "RANGE" }
            ],
            AttributeDefinitions: [
                { AttributeName: "DevName", AttributeType: "S" },
                { AttributeName: "Timestamp", AttributeType: "S" }
            ],
            ProvisionedThroughput: {
                ReadCapacityUnits: 5,
                WriteCapacityUnits: 5
            }
        };

        var tcreated = await new Promise(function(resolve, reject) { 
            _dynoDB.createTable(params, function(err, data) {
                if (err) {
                    console.log('missing table ['+MSG_TABLE+'], creating failed:'+err);
                    resolve(false);
                } else {
                    resolve(true);
                }
            });
        });
        return tcreated;
    }
    return true;        // everything is ok
}

module.exports = { addMsgToTable };